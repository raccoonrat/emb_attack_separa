# OKR 实验结果解读指南

## 实验结果概览

### 关键指标

从 `results.json` 中可以看到以下关键指标：

```json
{
  "summary": {
    "total_samples": 3,              // 总样本数
    "watermarked_samples": 0,        // 检测为水印的样本数
    "average_hit_rate": 0.0278,      // 平均命中率 (2.78%)
    "detection_threshold": 0.8       // 检测阈值 (80%)
  }
}
```

## 指标解读

### 1. **平均命中率 (average_hit_rate): 0.0278 (2.78%)**

**含义：**
- 在所有"有机会"的路由选择中，实际选择与水印指示一致的占比
- 0.0278 表示只有 2.78% 的路由选择匹配了水印信号

**期望值：**
- **无水印文本：** 命中率应该接近 `1/num_experts = 1/8 = 12.5%`（随机选择）
- **有水印文本：** 命中率应该显著高于随机值，理想情况下 > 80%

**当前结果分析：**
- 2.78% < 12.5%，说明：
  1. 要么水印没有正确注入
  2. 要么检测逻辑有问题
  3. 要么"机会窗口"太少（epsilon 太小，大部分时候模型很确定）

### 2. **检测为水印的样本数: 0**

**含义：**
- 没有任何样本的命中率超过阈值 0.8
- 所有样本都被判定为"Clean"（无水印）

**可能原因：**
1. **水印未正确注入：** router 的权重没有正确复制，使用了随机初始化
2. **检测逻辑问题：** 路由数据没有正确保存或提取
3. **Epsilon 太小：** 1.5 可能太小，导致"机会窗口"很少
4. **模型确定性太高：** Switch-base-8 在大多数情况下路由选择很确定，没有"犹豫"的机会

### 3. **详细结果分析**

#### 样本 0
```json
{
  "hit_rate": 0.0,
  "verdict": "Clean",
  "watermarked_text": ""  // 空文本，可能生成失败
}
```
- 命中率为 0，说明没有检测到任何水印信号
- 生成的文本为空，可能是生成过程出错

#### 样本 1
```json
{
  "hit_rate": 0.083,  // 8.3%
  "verdict": "Clean",
  "watermarked_text": "the.......???????..?.?.?..?..?..?..?..?..?.?.?.?.?.?..?..?..?..?..).)...).).).).).)).).).).)..).),)."
}
```
- 命中率 8.3%，接近随机值（12.5%），说明水印信号很弱
- 生成的文本看起来不正常（很多问号和标点），可能是生成参数问题

#### 样本 2
```json
{
  "hit_rate": 0.0,
  "verdict": "Clean",
  "watermarked_text": ""  // 空文本
}
```
- 同样没有检测到水印

## 问题诊断

### 可能的问题

1. **权重未正确复制**
   - 日志显示："警告: 无法找到 router 的权重，使用随机初始化"
   - **影响：** OKRRouter 使用的是随机权重，而不是原始模型的权重
   - **结果：** 路由选择完全错误，水印无法正常工作

2. **Epsilon 值可能不合适**
   - 当前 epsilon = 1.5
   - **建议：** 尝试更大的值（如 2.0, 3.0）以增加"机会窗口"

3. **检测逻辑问题**
   - 路由数据可能没有正确保存
   - 检测时使用的 hidden_states 可能不对

## 改进建议

### 1. 修复权重复制问题

需要正确获取 `SwitchTransformersTop1Router` 的权重。检查 router 的实际结构：

```python
# 在 okr_patch.py 中添加调试信息
router_params = dict(router.named_parameters())
print(f"Router 参数: {list(router_params.keys())}")
print(f"Router 属性: {[attr for attr in dir(router) if not attr.startswith('_')]}")
```

### 2. 调整 Epsilon 值

尝试不同的 epsilon 值：
- **较小值（0.5-1.0）：** 更保守，只在非常不确定时修改
- **中等值（1.5-2.5）：** 平衡质量和水印强度
- **较大值（3.0+）：** 更强的水印，但可能影响质量

### 3. 验证水印注入

添加验证代码，确认：
- Router 的 forward 方法是否被正确替换
- 路由数据是否被正确保存
- OKR router 的权重是否正确

### 4. 检查生成参数

生成的文本异常，检查：
- `max_length` 是否合适
- `num_beams` 和其他生成参数
- Tokenizer 是否正确处理输出

## 正常结果的期望值

### 理想情况下的指标

如果水印正确工作，应该看到：

```json
{
  "summary": {
    "average_hit_rate": 0.85,  // 85% 命中率（远高于随机值 12.5%）
    "watermarked_samples": 3,   // 所有样本都检测到水印
  },
  "detailed_results": [
    {
      "hit_rate": 0.82,  // 每个样本的命中率都 > 0.8
      "verdict": "Watermarked"
    }
  ]
}
```

### 命中率计算说明

**公式：**
```
命中率 = 命中次数 / 总机会次数

其中：
- 命中次数：实际选择的专家在水印指向的专家集合中
- 总机会次数：epsilon 安全区内有 >= 2 个专家的位置数
```

**示例：**
- 如果文本有 100 个 token
- 其中 50 个 token 有"机会窗口"（>= 2 个安全专家）
- 在这 50 个机会中，有 40 个选择了水印指向的专家
- 命中率 = 40/50 = 0.8 (80%)

## 下一步行动

1. **修复权重复制问题**（最重要）
   - 检查 `SwitchTransformersTop1Router` 的实际结构
   - 正确获取并复制权重

2. **增加调试信息**
   - 打印 router 的所有参数名称
   - 验证权重是否正确复制
   - 检查路由数据是否正确保存

3. **调整实验参数**
   - 尝试更大的 epsilon（如 2.5）
   - 使用更长的文本（增加机会窗口）
   - 检查生成参数

4. **验证检测逻辑**
   - 确认路由数据正确保存
   - 验证 hidden_states 的获取
   - 检查命中率计算逻辑

## 参考值

### 随机基线

对于 8 个专家的模型：
- **随机命中率：** 1/8 = 12.5%
- **如果命中率 < 12.5%：** 说明检测逻辑可能有问题
- **如果命中率 ≈ 12.5%：** 说明水印未生效（随机选择）
- **如果命中率 >> 12.5%：** 说明水印生效

### 当前结果

- **平均命中率：2.78%** < 12.5%
- **结论：** 水印未正确工作，需要修复权重复制问题

