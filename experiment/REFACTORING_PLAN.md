# 代码重构计划

## 执行摘要

基于论文逻辑验证和代码审查，本项目核心逻辑**完全符合论文**，但存在工程化问题需要改进。

## 已完成 ✅

1. ✅ 论文逻辑验证 - 核心公式全部正确实现
2. ✅ 创建工具模块 (`utils/`) - 错误处理、日志、性能优化
3. ✅ 代码审查报告 (`CODE_REVIEW.md`)

## 进行中 🔄

1. 🔄 清理重复代码
   - `moe_watermark.py` - 可删除（CausalLM实现，未使用）
   - `moe_watermark_enhanced.py` - 需要检查依赖后决定
   - `mves_watermark.py` - 可归档（旧实现）

## 待执行 ⏳

### 阶段1: 代码清理（高优先级）

1. **删除未使用的文件**
   - [ ] 确认`moe_watermark.py`无依赖后删除
   - [ ] 检查`moe_watermark_enhanced.py`的使用情况
   - [ ] 更新`deploy_switch_base8.py`和`deployment_validator.py`（如果使用旧实现）

2. **统一导入路径**
   - [ ] 所有文件统一使用`mves_watermark_corrected.py`
   - [ ] 更新`main.py`中的导入

### 阶段2: 错误处理和日志（高优先级）

1. **替换print为日志**
   - [ ] `main.py` - 使用`get_logger()`
   - [ ] `detector.py` - 使用`get_logger()`
   - [ ] `calibration.py` - 使用`get_logger()`
   - [ ] `experiments.py` - 使用`get_logger()`

2. **添加异常处理**
   - [ ] 关键路径添加try-catch
   - [ ] 使用统一的异常类型

### 阶段3: 性能优化（中优先级）

1. **批量处理优化**
   - [ ] `calibration.py` - 使用`batch_process()`
   - [ ] `experiments.py` - 批量处理数据

2. **内存管理**
   - [ ] 添加`@clear_cache`装饰器
   - [ ] 及时清理GPU缓存

### 阶段4: 完善实现（中优先级）

1. **完成标定方法**
   - [ ] `calibrate_Lg` - 完善实现
   - [ ] `calibrate_C_star` - 实现PPL测量

2. **实验B实现**
   - [ ] 实现KGW水印（用于对比实验）

### 阶段5: 测试和文档（低优先级）

1. **单元测试**
   - [ ] 核心模块测试
   - [ ] 集成测试

2. **文档完善**
   - [ ] API文档
   - [ ] 使用示例

## 重构原则

遵循Linus Torvalds的哲学：

1. **简洁性** - 消除不必要的复杂性
2. **实用性** - 解决实际问题，不追求理论完美
3. **健壮性** - 错误处理要完善，但不过度防御
4. **可维护性** - 代码清晰，易于理解

## 风险评估

- **低风险**: 删除未使用的文件、添加日志
- **中风险**: 重构导入路径、添加异常处理
- **高风险**: 修改核心算法逻辑（**不应进行**）

## 时间估算

- 阶段1: 2-3小时
- 阶段2: 3-4小时
- 阶段3: 2-3小时
- 阶段4: 4-6小时
- 阶段5: 4-6小时

**总计**: 15-22小时

